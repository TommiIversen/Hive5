@page "/"
@using Common.Models
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.SignalR.Client
@using StreamHub.Services
@inject EngineManager EngineManager
@inject WorkerService WorkerService


<h3>StreamHub Dashboard</h3>

<p>Forbindelsesstatus: @_connectionStatus</p>

@if (!EngineManager.GetAllEngines().Any())
{
    <p>Ingen engines forbundet.</p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Engine Info</th>
            <th>Workers</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var engine in EngineManager.GetAllEngines())
        {
            <tr>
                <td>
                    <div>
                        <strong>Engine ID:</strong> @engine.EngineId <br/>
                        <strong>CPU Usage (%):</strong> @(engine.LastMetric?.CPUUsage.ToString("F2") ?? "N/A") <br/>
                        <strong>Memory Usage (MB):</strong> @(engine.LastMetric?.MemoryUsage.ToString("F2") ?? "N/A") <br/>
                        <strong>Current Process CPU Usage (%):</strong> @(engine.LastMetric?.CurrentProcessCpuUsage.ToString("F2") ?? "N/A") <br/>

                        <!-- RAM-information -->
                        <strong>Total Memory (MB):</strong> @(engine.LastMetric?.TotalMemory.ToString("F2") ?? "N/A") <br/>
                        <strong>Available Memory (MB):</strong> @(engine.LastMetric?.AvailableMemory.ToString("F2") ?? "N/A") <br/>
                        <strong>Used Memory (MB):</strong> @(engine.LastMetric != null ? (engine.LastMetric.TotalMemory - engine.LastMetric.AvailableMemory).ToString("F2") : "N/A") <br/>
                        <strong>Used Memory (%):</strong> @(engine.LastMetric != null ? (((engine.LastMetric.TotalMemory - engine.LastMetric.AvailableMemory) / engine.LastMetric.TotalMemory) * 100).ToString("F2") : "N/A") <br/>
                        <strong>Current Process Memory Usage (MB):</strong> @(engine.LastMetric?.CurrentProcessMemoryUsage.ToString("F2") ?? "N/A") <br/>

                        <!-- Viser CPU-brug for hver kerne, hvis det er tilgængeligt -->
                        @if (engine.LastMetric?.PerCoreCpuUsage != null && engine.LastMetric.PerCoreCpuUsage.Count > 0)
                        {
                            <strong>Per Core CPU Usage (%):</strong>
                            <br/>
                            <ul>
                                @foreach (var usage in engine.LastMetric.PerCoreCpuUsage)
                                {
                                    <li>@usage.ToString("F2")%</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <strong>Per Core CPU Usage (%):</strong>
                        }
                    </div>
                </td>
                <td>
                    @if (engine.Workers.Any())
                    {
                        <table>
                            @foreach (var worker in engine.Workers.Values)
                            {
                                <tr>
                                    <td>
                                        <div>@worker.WorkerId</div>
                                        <div>
                                            <button @onclick="() => StopWorker(engine.EngineId, worker.WorkerId)"
                                                    disabled="@worker.IsProcessing">
                                                Stop
                                            </button>
                                        </div>
                                        <!-- Show result of the operation -->
                                        @if (!string.IsNullOrEmpty(worker.OperationResult))
                                        {
                                            <div>@worker.OperationResult</div>
                                        }
                                    </td>
                                    <td>
                                    </td>
                                    <td>
                                        @if (worker.LogMessages.Any())
                                        {
                                            <ul>
                                                @foreach (var logMessage in worker.LogMessages)
                                                {
                                                    <li>@logMessage</li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <p>Ingen logbeskeder.</p>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(worker.LastImage))
                                        {
                                            <img src="@worker.LastImage" alt="Worker Image" width="200"/>
                                        }
                                    </td>
                                </tr>
                            }
                        </table>
                    }
                    else
                    {
                        <p>Ingen workers.</p>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    private HubConnection? _hubConnection;
    private string _connectionStatus = "Ikke forbundet2";

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/streamhub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.Reconnecting += (_) =>
        {
            _connectionStatus = "Genopretter forbindelse...";
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };

        _hubConnection.Reconnected += (_) =>
        {
            _connectionStatus = "Forbundet";
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };

        _hubConnection.Closed += (_) =>
        {
            _connectionStatus = "Ikke forbundet";
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };

        _hubConnection.On<Metric>("UpdateMetric", async (_) =>
        {
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<LogEntry>("ReceiveLog", async (_) =>
        {
            await InvokeAsync(StateHasChanged);
        });


        _hubConnection.On<ImageData>("ReceiveImage", async (_) =>
        {
            await InvokeAsync(StateHasChanged);
        });

        // Start forbindelsen
        try
        {
            await _hubConnection.StartAsync();
            _connectionStatus = "Forbundet";
            Console.WriteLine("SignalR connected.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting SignalR connection: {ex.Message}");
            _connectionStatus = "Fejl ved oprettelse af forbindelse";
        }
    }

    private async Task<string> StopWorker(Guid engineId, Guid workerId)
    {
        var result = await WorkerService.StopWorkerAsync(engineId, workerId);
        Console.WriteLine($"RESULT: {result.Message}");
        await InvokeAsync(StateHasChanged);
        return result.Message;
    }
}